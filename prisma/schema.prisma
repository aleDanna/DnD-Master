// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication Models (NextAuth.js)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// User Model
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  passwordHash  String?   @map("password_hash")
  displayName   String    @map("display_name")
  avatarUrl     String?   @map("avatar_url")
  preferences   Json      @default("{}")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  accounts         Account[]
  sessions         Session[]
  characters       Character[]
  ownedCampaigns   Campaign[]        @relation("CampaignOwner")
  campaignPlayers  CampaignPlayer[]
  sessionEvents    SessionEvent[]

  @@map("users")
}

// ============================================
// Character Model
// ============================================

model Character {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  campaignId       String?  @map("campaign_id")

  // Basic Info
  name             String
  race             Json     // Race data including subraces
  classes          Json     // Array of class data with levels
  level            Int      @default(1)
  experiencePoints Int      @default(0) @map("experience_points")
  background       Json?    // Background data
  alignment        String?

  // Ability Scores
  abilityScores    Json     @map("ability_scores")

  // Combat Stats
  maxHitPoints        Int   @map("max_hit_points")
  currentHitPoints    Int   @map("current_hit_points")
  temporaryHitPoints  Int   @default(0) @map("temporary_hit_points")
  armorClass          Int   @default(10) @map("armor_class")
  speed               Int   @default(30)
  hitDice             Json  @default("[]") @map("hit_dice")
  deathSaves          Json  @default("{\"successes\": 0, \"failures\": 0}") @map("death_saves")

  // Proficiencies
  proficiencies    Json     @default("{}")

  // Features & Traits
  features         Json     @default("[]")

  // Equipment
  equipment        Json     @default("[]")
  currency         Json     @default("{\"cp\": 0, \"sp\": 0, \"ep\": 0, \"gp\": 0, \"pp\": 0}")

  // Spellcasting (optional)
  spellcasting     Json?

  // Personality
  personality      Json     @default("{}")
  backstory        String?  @db.Text
  appearance       Json?

  // State
  conditions       Json     @default("[]")
  exhaustionLevel  Int      @default(0) @map("exhaustion_level")
  inspiration      Boolean  @default(false)

  // Metadata
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign         Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignPlayer   CampaignPlayer?

  @@index([userId])
  @@index([campaignId])
  @@map("characters")
}

// ============================================
// Campaign Model
// ============================================

model Campaign {
  id          String   @id @default(cuid())
  ownerId     String   @map("owner_id")

  // Basic Info
  name        String
  description String?  @db.Text
  setting     String?  @db.Text
  startingLevel Int    @default(1) @map("starting_level")

  // World State
  worldState  Json     @default("{}") @map("world_state")

  // Configuration
  settings    Json     @default("{}")
  houseRules  Json     @default("[]") @map("house_rules")

  // Status
  status      CampaignStatus @default(ACTIVE)

  // Metadata
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner            User              @relation("CampaignOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  players          CampaignPlayer[]
  characters       Character[]
  gameSessions     GameSession[]
  npcs             NPC[]
  locations        Location[]
  quests           Quest[]

  @@index([ownerId])
  @@map("campaigns")
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

// ============================================
// Campaign Player (Join Table)
// ============================================

model CampaignPlayer {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")
  userId      String   @map("user_id")
  characterId String?  @unique @map("character_id")

  role        PlayerRole @default(PLAYER)
  joinedAt    DateTime   @default(now()) @map("joined_at")

  // Relations
  campaign    Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)

  @@unique([campaignId, userId])
  @@map("campaign_players")
}

enum PlayerRole {
  PLAYER
  CO_DM
  SPECTATOR
}

// ============================================
// Game Session Model
// ============================================

model GameSession {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")

  // Status
  status      SessionStatus @default(PREPARING)
  startedAt   DateTime?     @map("started_at")
  endedAt     DateTime?     @map("ended_at")

  // Game State
  gameState   Json          @default("{}") @map("game_state")

  // Combat State (if in combat)
  combatState Json?         @map("combat_state")

  // Narrative Context
  narrativeContext Json     @default("{}") @map("narrative_context")

  // Voice
  voiceEnabled Boolean      @default(false) @map("voice_enabled")

  // Metadata
  createdAt   DateTime      @default(now()) @map("created_at")

  // Relations
  campaign    Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  events      SessionEvent[]

  @@index([campaignId])
  @@map("game_sessions")
}

enum SessionStatus {
  PREPARING
  ACTIVE
  PAUSED
  ENDED
}

// ============================================
// Session Event (Audit Log)
// ============================================

model SessionEvent {
  id          String   @id @default(cuid())
  sessionId   String   @map("session_id")

  eventType   String   @map("event_type")
  eventData   Json     @map("event_data")
  actorId     String?  @map("actor_id")

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  session     GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actor       User?       @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([createdAt])
  @@map("session_events")
}

// ============================================
// NPC Model
// ============================================

model NPC {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")

  name        String
  description String?  @db.Text
  personality String?  @db.Text
  appearance  String?  @db.Text

  // Stats (optional, for combat NPCs)
  stats       Json?

  // Location
  locationId  String?  @map("location_id")

  // Knowledge & Relationships
  knowledge   Json     @default("[]")
  relationships Json   @default("{}")

  // Goals
  goals       Json     @default("[]")

  // State
  isAlive     Boolean  @default(true) @map("is_alive")

  // Metadata
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  campaign    Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  location    Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@map("npcs")
}

// ============================================
// Location Model
// ============================================

model Location {
  id               String   @id @default(cuid())
  campaignId       String   @map("campaign_id")
  parentLocationId String?  @map("parent_location_id")

  name             String
  description      String?  @db.Text
  locationType     String?  @map("location_type")

  // Properties
  properties       Json     @default("{}")

  // Metadata
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  campaign         Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  parentLocation   Location? @relation("LocationHierarchy", fields: [parentLocationId], references: [id], onDelete: SetNull)
  childLocations   Location[] @relation("LocationHierarchy")
  npcs             NPC[]

  @@index([campaignId])
  @@map("locations")
}

// ============================================
// Quest Model
// ============================================

model Quest {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")

  title       String
  description String?  @db.Text

  // Quest State
  status      QuestStatus @default(AVAILABLE)

  // Objectives
  objectives  Json     @default("[]")

  // Rewards
  rewards     Json     @default("{}")

  // Metadata
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("quests")
}

enum QuestStatus {
  AVAILABLE
  ACTIVE
  COMPLETED
  FAILED
  HIDDEN
}
