# Feature Specification: D&D Content SQL Migration Script

**Feature Branch**: `002-dnd-content-migration`
**Created**: 2026-01-29
**Status**: Draft
**Input**: User description: "Generate a pure PostgreSQL 18 SQL script that reads, parses, and transposes all D&D rules and player handbook content from source documents located in /docs into a normalized relational database schema with pgvector support for semantic search."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Database Administrator Initializes Game Content (Priority: P1)

A database administrator needs to set up the D&D content database for the AI Dungeon Master application. They run a single SQL script that creates all necessary tables, indexes, and populates the database with all D&D rules and handbook content extracted from the source documents in the `/docs` folder.

**Why this priority**: Without the database populated with game content, the AI Dungeon Master application cannot provide any rules lookup or contextual gameplay assistance. This is the foundational capability that enables all other features.

**Independent Test**: Can be fully tested by running the SQL script on a fresh PostgreSQL database and verifying that all tables are created with data populated. Delivers immediate value by enabling rules queries.

**Acceptance Scenarios**:

1. **Given** a fresh PostgreSQL 18 database with no existing tables, **When** the SQL script is executed, **Then** all required tables are created without errors and the database contains structured D&D content.
2. **Given** a database where the script has already been run, **When** the script is executed again, **Then** the script completes without errors (idempotent execution) and no data is duplicated.
3. **Given** the SQL script has been executed successfully, **When** a user queries for rules about "initiative", **Then** the database returns the relevant combat rules content.

---

### User Story 2 - Game Master Searches for Combat Rules (Priority: P2)

A Game Master using the AI Dungeon Master application needs to quickly look up specific combat rules during a game session. They search for "opportunity attack" and receive the complete rule text with page references to the source material.

**Why this priority**: Rules lookup is the primary use case for the structured content. Game Masters need instant access to rules during gameplay sessions.

**Independent Test**: Can be tested by running search queries against the populated database and verifying relevant, accurate results are returned.

**Acceptance Scenarios**:

1. **Given** a populated D&D content database, **When** a user searches for "attack of opportunity", **Then** the system returns the rule entry about opportunity attacks with the complete rule text.
2. **Given** a populated D&D content database, **When** a user searches for "fireball", **Then** the system returns the spell description with all relevant attributes (level, range, components, duration, description).
3. **Given** a populated D&D content database, **When** a user searches for a term that appears in multiple rules, **Then** the system returns all matching entries ordered by relevance.

---

### User Story 3 - Developer Extends Database with Vector Embeddings (Priority: P3)

A developer needs to add semantic search capabilities to the application. The database schema already includes placeholder columns for vector embeddings, allowing them to populate these columns with embeddings generated by an AI model without modifying the schema.

**Why this priority**: Semantic search enhances the user experience but is not required for basic functionality. The schema should support this future capability from the start.

**Independent Test**: Can be tested by verifying embedding columns exist and can be populated with vector data.

**Acceptance Scenarios**:

1. **Given** the database schema has been created, **When** a developer inspects the content tables, **Then** each content table includes an embedding column ready for vector data.
2. **Given** embedding columns exist in content tables, **When** a developer populates an embedding column with vector data, **Then** the database accepts the data without schema modifications.

---

### User Story 4 - AI Assistant Retrieves Contextual Rules (Priority: P2)

The AI Dungeon Master assistant needs to retrieve relevant rules based on the current game context. When a player asks about spell slots while playing a wizard, the assistant queries the database for spellcasting rules, wizard-specific spell slot progression, and related magical rules.

**Why this priority**: This is the core value proposition of the AI Dungeon Master - providing contextual, accurate rule information during gameplay.

**Independent Test**: Can be tested by querying for rules by category, class, or topic and verifying complete, accurate results.

**Acceptance Scenarios**:

1. **Given** a populated D&D content database, **When** the assistant queries for all spellcasting rules, **Then** the database returns all spellcasting-related content organized by chapter and section.
2. **Given** a populated D&D content database, **When** the assistant queries for a specific class's features, **Then** the database returns all class features with their level requirements.
3. **Given** a populated D&D content database, **When** the assistant queries for monster statistics, **Then** the database returns complete stat blocks including abilities, actions, and traits.

---

### Edge Cases

- What happens when the source document contains malformed or incomplete content sections?
- How does the system handle special characters (em-dashes, curly quotes, non-ASCII characters) in rule text?
- What happens when a rule references another rule that appears later in the document?
- How are multi-page rules or spells that span page breaks handled?
- What happens when the same rule appears in both Basic Rules and Player's Handbook with slight variations?
- How are tables (spell lists, equipment tables, monster stat blocks) represented in the database?

## Requirements *(mandatory)*

### Functional Requirements

**Document Processing**
- **FR-001**: System MUST read and parse all text documents (.txt) from the `/docs` folder
- **FR-002**: System MUST identify and distinguish between Rules documents and Player's Handbook documents
- **FR-003**: System MUST extract document structure including chapters, sections, and subsections
- **FR-004**: System MUST preserve original page references where available in the source text

**Content Extraction - Rules**
- **FR-005**: System MUST extract all rule categories (e.g., Combat, Movement, Spellcasting, Conditions)
- **FR-006**: System MUST extract individual rules with their complete text content
- **FR-007**: System MUST maintain hierarchical relationships between chapters, sections, and rule entries
- **FR-008**: System MUST capture cross-references between related rules

**Content Extraction - Player's Handbook Entities**
- **FR-009**: System MUST extract all playable races with their traits, ability modifiers, and features
- **FR-010**: System MUST extract all character classes with hit dice, proficiencies, and progression tables
- **FR-011**: System MUST extract all subclasses linked to their parent classes
- **FR-012**: System MUST extract all class features with their level requirements
- **FR-013**: System MUST extract all spells with complete attributes (level, school, casting time, range, components, duration, description)
- **FR-014**: System MUST extract all backgrounds with their features, proficiencies, and equipment
- **FR-015**: System MUST extract all feats with their prerequisites and benefits
- **FR-016**: System MUST extract all equipment including weapons, armor, and adventuring gear
- **FR-017**: System MUST extract all monsters with complete stat blocks
- **FR-018**: System MUST extract all conditions and their effects

**Database Schema**
- **FR-019**: System MUST create a normalized relational schema with appropriate foreign key relationships
- **FR-020**: System MUST include unique identifiers for all entities
- **FR-021**: System MUST include timestamps (created_at, updated_at) on all tables
- **FR-022**: System MUST include placeholder columns for vector embeddings on all content tables
- **FR-023**: System MUST support full-text search on all content fields
- **FR-024**: System MUST track source document and page reference for all extracted content

**Data Quality**
- **FR-025**: System MUST properly escape all special characters in content
- **FR-026**: System MUST generate URL-safe slugs for all named entities
- **FR-027**: System MUST handle missing or optional fields gracefully with NULL values

**Script Execution**
- **FR-028**: System MUST produce a single SQL file that can be run on PostgreSQL 18
- **FR-029**: System MUST be idempotent - running multiple times produces consistent results without duplicating data
- **FR-030**: System MUST include verification queries to confirm data integrity after execution

### Key Entities

- **Source Document**: Represents a source file (rules.txt, handbook.txt) with metadata about document type, title, and processing status
- **Chapter**: A major division within a source document, containing sections and establishing document hierarchy
- **Section**: A subdivision of a chapter containing related rules or content, enabling organized navigation
- **Rule Entry**: An individual rule or piece of content with its complete text, page reference, and category associations
- **Rule Category**: A classification grouping for rules (Combat, Movement, Spellcasting) enabling filtered searches
- **Race**: A playable character race with traits, ability modifiers, and special features
- **Subrace**: A variant of a parent race with additional or modified traits
- **Class**: A playable character class with hit dice, proficiencies, and level progression
- **Subclass**: A specialization of a parent class available at specific levels
- **Class Feature**: An ability or trait gained by a class at a specific level
- **Spell**: A magical effect with level, school, components, casting time, range, duration, and description
- **Monster**: A creature with complete statistics including abilities, actions, and special traits
- **Item**: Equipment including weapons, armor, and adventuring gear with relevant properties
- **Background**: A character background with features, proficiencies, and starting equipment
- **Feat**: An optional character enhancement with prerequisites and benefits
- **Condition**: A status effect with its mechanical impacts on gameplay

### Assumptions

- Source documents (rules.txt, handbook.txt) are plain text files with consistent formatting patterns
- Chapter headers follow a recognizable pattern (e.g., "Ch. 1:", "Part 1:", "CHAPTER 1")
- The source documents contain D&D 5th Edition content (Basic Rules v1.0 and Player's Handbook)
- PostgreSQL 18 with pgvector extension is available in the target environment
- The PDF files in /docs are placeholder files (2 bytes each) and will not be processed
- Vector embeddings will be populated separately after initial data load

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: All content from source documents is extracted - 100% of chapters, sections, and distinct rule entries present in the text files are represented in the database
- **SC-002**: Database queries return accurate results - searching for any rule by keyword returns relevant content within the top 5 results
- **SC-003**: Script executes successfully on a fresh database in under 60 seconds
- **SC-004**: Script is idempotent - running the script 3 times consecutively produces identical data counts with no duplicates
- **SC-005**: All spell entries include complete attributes (name, level, school, casting time, range, components, duration, description) with no more than 5% having missing optional fields
- **SC-006**: All monster entries include complete stat blocks (name, type, size, AC, HP, abilities, actions) with no more than 5% having missing optional fields
- **SC-007**: Full-text search queries return results in under 100 milliseconds for databases with up to 10,000 entries
- **SC-008**: Every content record can be traced back to its source document and approximate location within that document
